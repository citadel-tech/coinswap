# Test environment Dockerfile
ARG BUILDER_IMAGE=coinswap-builder:latest
FROM ${BUILDER_IMAGE} AS builder

# The test environment needs the full rust toolchain, so we don't use the minimal base image.
FROM rust:1.90-alpine3.20

# Install system dependencies for testing
RUN apk add --no-cache \
    ca-certificates \
    openssl \
    libgcc \
    curl \
    git \
    build-base \
    cmake \
    pkgconfig \
    openssl-dev \
    sqlite-dev \
    sqlite-static \
    zeromq-dev

# Create app user
RUN adduser -D -u 1001 coinswap

# Create directories
RUN mkdir -p /app/bin /home/coinswap/.coinswap && \
    chown -R coinswap:coinswap /app /home/coinswap

# Copy all binaries from builder
COPY --from=builder /usr/src/coinswap/target/release/* /app/bin/

# Copy source code for tests (from current context)
COPY . /app/source

# Set proper permissions
RUN chmod +x /app/bin/* && \
    chown -R coinswap:coinswap /app/source

# Switch to app user
USER coinswap
WORKDIR /app/source

# Add binaries to PATH
ENV PATH="/app/bin:$PATH"

# Set environment variables for data directories
ENV COINSWAP_DATA_DIR="/home/coinswap/.coinswap"

# Create volume mount point
VOLUME ["/home/coinswap/.coinswap"]

# Default command - run integration tests (exclude examples)
CMD ["cargo", "test", "--features=integration-test", "--lib", "--bins", "--", "--nocapture"]