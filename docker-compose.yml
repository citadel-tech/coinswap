version: '3.8'

services:
  # Bitcoin Core node for blockchain operations
  bitcoind:
    image: coinswap
    container_name: coinswap-bitcoind
    command: |
      sh -c "
      mkdir -p /home/coinswap/.bitcoin &&
      cat > /home/coinswap/.bitcoin/bitcoin.conf << EOF
      regtest=1
      server=1
      fallbackfee=0.0001
      rpcuser=coinswap
      rpcpassword=coinswappass
      rpcallowip=0.0.0.0/0
      rpcbind=0.0.0.0:18332
      txindex=1
      EOF
      bitcoind -datadir=/home/coinswap/.bitcoin
      "
    ports:
      - "18332:18332"
    volumes:
      - bitcoin-data:/home/coinswap/.bitcoin
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-datadir=/home/coinswap/.bitcoin", "getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Tor proxy for privacy
  tor:
    image: coinswap
    container_name: coinswap-tor
    command: |
      sh -c "
      mkdir -p /etc/tor &&
      cat > /etc/tor/torrc << EOF
      SOCKSPort 0.0.0.0:9050
      ControlPort 0.0.0.0:9051
      DataDirectory /home/coinswap/.tor
      EOF
      tor -f /etc/tor/torrc
      "
    ports:
      - "9050:9050"
      - "9051:9051"
    volumes:
      - tor-data:/home/coinswap/.tor
    restart: unless-stopped

  # Directory server for maker discovery
  directory:
    image: coinswap
    container_name: coinswap-directory
    command: |
      sh -c "
      sleep 10 &&
      directoryd
      "
    ports:
      - "8080:8080"
    volumes:
      - directory-data:/home/coinswap/.coinswap
    depends_on:
      - bitcoind
      - tor
    restart: unless-stopped

  # Maker daemon
  makerd:
    image: coinswap
    container_name: coinswap-makerd
    command: |
      sh -c "
      sleep 15 &&
      mkdir -p /home/coinswap/.coinswap/maker &&
      cat > /home/coinswap/.coinswap/maker/config.toml << EOF
      network_port = 6102
      rpc_port = 6103
      socks_port = 9050
      control_port = 9051
      tor_auth_password = \"\"
      min_swap_amount = 10000
      fidelity_amount = 50000
      fidelity_timelock = 13104
      connection_type = \"TOR\"
      directory_server_address = \"directory:8080\"
      base_fee = 100
      amount_relative_fee_pct = 0.1
      EOF
      makerd
      "
    ports:
      - "6102:6102"
      - "6103:6103"
    volumes:
      - maker-data:/home/coinswap/.coinswap
    depends_on:
      - bitcoind
      - tor
      - directory
    restart: unless-stopped

volumes:
  bitcoin-data:
    driver: local
  tor-data:
    driver: local
  directory-data:
    driver: local
  maker-data:
    driver: local

networks:
  default:
    name: coinswap-network
